<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>MongoDB 資料查詢</title>

    <th:block th:if="${_csrf}">
        <meta name="_csrf" th:content="${_csrf.token}"/>
        <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    </th:block>

    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
            line-height: 1.6;
            background-color: #f4f7f6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #4b6cb7;
            border-bottom: 2px solid #4b6cb7;
            padding-bottom: 0.5em;
            margin-bottom: 1.5em;
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        label {
            font-weight: bold;
            color: #333;
        }
        select, input[type="number"] {
            padding: 8px 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            min-width: 150px;
        }

        /* 查詢條件區塊 */
        .query-conditions {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .query-conditions h3 {
            margin-top: 0;
            color: #4b6cb7;
        }
        .json-input-group {
            margin-bottom: 15px;
        }
        .json-input-group label {
            display: block;
            margin-bottom: 5px;
        }
        textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }

        /* 按鈕樣式 */
        #execute-query-btn, .view-toggle-btn {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
            margin-left: 5px;
        }
        #execute-query-btn:hover, .view-toggle-btn:hover {
            background-color: #218838;
        }
        .view-toggle-btn {
            background-color: #4b6cb7;
        }
        .view-toggle-btn.active {
            background-color: #385a97;
            border: 2px solid #5a7bd7;
        }

        /* 訊息區塊 */
        .message-box {
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
            font-weight: bold;
            word-break: break-all;
        }
        .info {
            background-color: #e0f7fa;
            color: #00838f;
            border: 1px solid #00acc1;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* 結果表格樣式 */
        #results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
            table-layout: fixed;
        }
        #results-table th, #results-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #results-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        #results-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* 分頁資訊 */
        #pagination-info {
            margin-top: 10px;
            font-weight: bold;
            color: #555;
        }
        .pagination {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-top: 10px;
            gap: 5px;
        }
        .pagination button {
            padding: 6px 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* --- JSON Tree View 樣式 --- */
        #results-tree-view {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #fafafa;
            display: none; /* 預設隱藏 */
            white-space: pre;
            font-family: monospace;
            font-size: 14px;
        }

        .document-item {
            border: 1px solid #ddd;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #fff;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .document-header {
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
        }
        /* 箭頭圖示的基礎樣式 */
        .document-header::before {
            content: "▶"; /* 預設是收合 */
            margin-right: 8px;
            transition: transform 0.2s;
            display: inline-block;
            color: #4b6cb7;
        }

        /* 頂層 document-item 展開 */
        .document-item.expanded > .document-header::before {
            content: "▼"; /* 展開時 */
            transform: rotate(0deg);
        }
        /* 修正縮排 1: document-content 只有左邊線，沒有左邊距 */
        .document-item > .document-content {
            border-left: 1px dotted #ccc;
            margin-top: 5px;
            display: none; /* 預設收合 */
        }
        .document-item.expanded > .document-content {
            display: block;
        }

        /* 巢狀結構的可收合容器 */
        .json-collapsible > .document-header::before {
            content: "▶"; /* 預設是收合 */
            margin-right: 8px;
            transition: transform 0.2s;
            display: inline-block;
            color: #4b6cb7;
        }

        .json-collapsible.expanded > .document-header::before {
            content: "▼"; /* 展開時 */
            transform: rotate(0deg);
        }

        .json-collapsible > .document-content {
            display: none; /* 預設收合 */
        }

        .json-collapsible.expanded > .document-content {
            display: block; /* 展開時顯示 */
        }

        /* 修正縮排 2: 對所有內容行和巢狀容器增加一致的左邊距 */
        .tree-line-content, .json-collapsible {
            margin-left: 15px; /* 增加縮排 */
            padding-left: 5px; /* 額外空間 */
        }

        .tree-key {
            color: #880000; /* JSON Key 顏色 */
            font-weight: bold;
            margin-right: 5px;
        }
        .tree-value {
            color: #008800; /* 字串值 顏色 */
        }
        .tree-value.number {
            color: #0000ff; /* 數值 顏色 */
        }
        .tree-value.boolean {
            color: #ff00ff; /* 布林值 顏色 */
        }
        .tree-value.null {
            color: #777777; /* Null 值 顏色 */
        }
        .tree-value.object, .tree-value.array {
            color: #000000;
        }
        .json-line {
            line-height: 1.5;
        }
    </style>
</head>

<body>

<div class="container">
    <h1>MongoDB 資料查詢</h1>

    <div class="controls">
        <div class="control-group">
            <label for="database-select">資料庫 (Database):</label>
            <select id="database-select">
                <option value="">載入中...</option>
            </select>
        </div>
        <div class="control-group">
            <label for="collection-select">集合 (Collection):</label>
            <select id="collection-select" disabled>
                <option value="">請選擇資料庫</option>
            </select>
        </div>
    </div>

    <div class="query-conditions">
        <h3>查詢條件 (JSON 字串)</h3>
        <div class="json-input-group">
            <label for="filter-input">Filter (篩選):</label>
            <textarea id="filter-input" placeholder="例如: {&quot;price&quot;: {&quot;$gte&quot;: 1000}}" rows="3">{}</textarea>
        </div>
        <div class="json-input-group">
            <label for="projection-input">Projection (投影/欄位選擇):</label>
            <textarea id="projection-input" placeholder="例如: {&quot;name&quot;: 1, &quot;price&quot;: 1, &quot;_id&quot;: 0}">{}</textarea>
        </div>
        <div class="json-input-group">
            <label for="sort-input">Sort (排序):</label>
            <textarea id="sort-input" placeholder="例如: {&quot;_id&quot;: -1}" rows="2">{}</textarea>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="page-size-input">每頁筆數 (Size):</label>
                <input type="number" id="page-size-input" value="20" min="1" style="min-width: 80px;">
            </div>

            <button id="execute-query-btn">執行查詢</button>
            <span id="loading-indicator" style="color: #4b6cb7; display: none; margin-left: 10px;">資料載入中...</span>
        </div>
    </div>

    <div id="message-area" class="message-box info">
        請選擇資料庫與集合，並點擊「執行查詢」。
    </div>

    <div class="controls" style="justify-content: space-between; margin-top: 15px;">
        <div id="pagination-controls" class="pagination"></div>
        <div id="view-mode-controls" style="display: none;">
            <span id="pagination-info" style="margin-right: 15px;"></span>
            <button id="table-view-btn" class="view-toggle-btn active" data-view="table">欄位模式 (Table)</button>
            <button id="tree-view-btn" class="view-toggle-btn" data-view="tree">收合模式 (Tree)</button>
        </div>
    </div>


    <table id="results-table" style="display: none;">
        <thead>
        <tr id="results-header"></tr>
        </thead>
        <tbody id="results-body">
        </tbody>
    </table>

    <div id="results-tree-view">
    </div>


</div>

<script>
    const API_BASE_URL = "/DBridge/api/mongodb";
    const DATABASES_URL = `${API_BASE_URL}/databases`;
    const COLLECTIONS_URL = `${API_BASE_URL}/collections`;
    const QUERY_URL = `${API_BASE_URL}/query`;

    // 獲取 CSRF Token 和 Header 名稱
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

    // 全域狀態
    let currentDatabase = '';
    let currentCollection = '';
    let currentPage = 1;
    let totalCount = 0;
    let currentResults = null; // 儲存原始查詢結果，用於兩種視圖切換
    let currentViewMode = 'table'; // 'table' 或 'tree'

    // 元素參照
    const databaseSelect = document.getElementById("database-select");
    const collectionSelect = document.getElementById("collection-select");
    const executeBtn = document.getElementById("execute-query-btn");
    const loadingIndicator = document.getElementById("loading-indicator");
    const messageArea = document.getElementById("message-area");
    const filterInput = document.getElementById("filter-input");
    const projectionInput = document.getElementById("projection-input");
    const sortInput = document.getElementById("sort-input");
    const pageSizeInput = document.getElementById("page-size-input");
    const resultsTable = document.getElementById("results-table");
    const resultsHeader = document.getElementById("results-header");
    const resultsBody = document.getElementById("results-body");
    const paginationInfo = document.getElementById("pagination-info");
    const paginationControls = document.getElementById("pagination-controls");
    const viewModeControls = document.getElementById("view-mode-controls");
    const tableViewBtn = document.getElementById("table-view-btn");
    const treeViewBtn = document.getElementById("tree-view-btn");
    const resultsTreeView = document.getElementById("results-tree-view");

    // --- 輔助函數 ---

    // 取得帶有 CSRF Header 的請求設定
    function getRequestOptions(bodyData = {}) {
        const options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(bodyData)
        };
        if (csrfToken && csrfHeader) {
            options.headers[csrfHeader] = csrfToken;
        }
        return options;
    }

    // 檢查 JSON 格式是否有效
    function isValidJson(str) {
        if (!str || str.trim() === '{}') return true;
        try {
            JSON.parse(str);
        } catch (e) {
            return false;
        }
        return true;
    }

    // 更新狀態訊息
    function updateStatusMessage(message, type = 'info') {
        messageArea.textContent = message;
        messageArea.className = `message-box ${type}`;
    }

    // 清理結果區域 (表格和分頁)
    function clearResultsArea() {
        resultsTable.style.display = 'none';
        resultsTreeView.style.display = 'none';
        resultsBody.innerHTML = '';
        resultsHeader.innerHTML = '';
        paginationInfo.innerHTML = '';
        paginationControls.innerHTML = '';
        viewModeControls.style.display = 'none';
        currentResults = null;
    }

    // HTML 編碼
    function escapeHtml(s) {
        if (s === null || typeof s === 'undefined') return '—';
        s = String(s);
        return s.replace(/[&<>"']/g, c => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
        }[c]));
    }

    // 渲染表格儲存格內容
    function renderCellContent(value) {
        if (value === null || typeof value === 'undefined') return '—';

        if (typeof value === 'object') {
            try {
                // 後端已攤平，但如果值是 Array 或 Object (沒有被攤平)，仍顯示為 JSON 字串
                const jsonString = JSON.stringify(value);
                const escaped = escapeHtml(jsonString);

                if (escaped.length > 150) {
                    return `<span title="${escaped}">${escaped.substring(0, 150)}... [物件/陣列]</span>`;
                }
                return escaped;

            } catch (e) {
                return 'Object';
            }
        }
        return escapeHtml(value);
    }

    // 將攤平 (Flattened) 的物件還原為巢狀物件
    function unflattenDocument(flattenedMap) {
        const result = {};
        for (const key in flattenedMap) {
            if (!Object.prototype.hasOwnProperty.call(flattenedMap, key)) {
                continue;
            }

            const value = flattenedMap[key];
            const parts = key.split('.');
            let current = result;

            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];

                if (i === parts.length - 1) {
                    // 這是最後一部分 (葉子節點)，賦予值
                    current[part] = value;
                } else {
                    // 這是中間節點，確保它是物件
                    if (!current[part]) {
                        current[part] = {};
                    }
                    current = current[part];
                }
            }
        }
        return result;
    }

    // --- JSON Tree View 渲染邏輯 ---

    function getTypeClass(value) {
        if (value === null) return 'null';
        if (typeof value === 'number') return 'number';
        if (typeof value === 'boolean') return 'boolean';
        if (Array.isArray(value)) return 'array';
        if (typeof value === 'object' && value !== null) return 'object';
        return ''; // string
    }

    // 遞迴渲染 JSON/Object/Array
    function buildTreeItem(key, value) {
        let html = '';
        const type = getTypeClass(value);
        const isCollapsible = type === 'object' || type === 'array';

        if (isCollapsible) {
            // 對於 Object 或 Array，建立可收合的容器
            html += `<div class="json-collapsible" data-is-collapsible="true">`;

            // Header: 鍵 + 類型摘要 (點擊切換展開/收合)
            let headerText = key ? `<span class="tree-key">${escapeHtml(key)}</span>: ` : '';
            headerText += (type === 'array' ? `Array(${value.length})` : `Object(${Object.keys(value).length})`);

            // 圖示和文本放在 document-header 內
            html += `<span class="document-header" data-key="${key}" data-type="${type}">${headerText}</span>`;

            // Content: 遞迴渲染內部內容 (預設收合，由 CSS 控制)
            html += `<div class="document-content">`;

            if (type === 'object') {
                for (const subKey in value) {
                    html += buildTreeItem(subKey, value[subKey]);
                }
            } else if (type === 'array') {
                value.forEach((item, index) => {
                    // 對 Array 元素使用索引作為鍵
                    html += buildTreeItem(index.toString(), item);
                });
            }

            html += `</div>`; // 關閉 document-content
            html += `</div>`; // 關閉 json-collapsible

        } else {
            // 對於基本類型，使用 tree-line-content 容器來處理縮排
            html += `<div class="tree-line-content">`;
            html += `<div class="json-line">`;
            if (key) {
                html += `<span class="tree-key">${escapeHtml(key)}</span>: `;
            }
            let displayValue;
            if (value === null) {
                displayValue = 'null';
            } else if (typeof value === 'string') {
                displayValue = `"${escapeHtml(value)}"`;
            } else if (value instanceof Date) {
                // 處理日期對象的顯示
                displayValue = `Date("${value.toISOString()}")`;
            } else {
                displayValue = escapeHtml(value);
            }

            html += `<span class="tree-value ${type}">${displayValue}</span>`;
            html += `</div>`;
            html += `</div>`; // 關閉 tree-line-content
        }

        return html;
    }

    // 渲染整個 Tree View (預設展開頂層文件)
    function renderTreeView(rows) {
        resultsTreeView.innerHTML = '';

        let documentsHtml = '';
        rows.forEach((row, index) => {
            // 1. 將攤平的 row (Map) 還原為巢狀結構
            const unflattenedDoc = unflattenDocument(row);

            const docId = unflattenedDoc._id || `Document ${index + 1}`;

            // 頂層容器 (使用 document-item)
            // *** 預設添加 expanded 類別到 document-item (展開第一層) ***
            let itemHtml = `<div class="document-item expanded" data-id="${docId}">`;
            itemHtml += `<div class="document-header">${docId}</div>`;
            itemHtml += `<div class="document-content">`;

            // 2. 遞迴渲染還原後的物件
            for (const key in unflattenedDoc) {
                itemHtml += buildTreeItem(key, unflattenedDoc[key]);
            }

            itemHtml += `</div>`; // 關閉 document-content
            itemHtml += `</div>`; // 關閉 document-item

            documentsHtml += itemHtml;
        });

        resultsTreeView.innerHTML = documentsHtml;

        // 綁定收合/展開事件 (頂層 document-item)
        document.querySelectorAll('#results-tree-view .document-item').forEach(item => {
            item.querySelector('.document-header').addEventListener('click', function() {
                item.classList.toggle('expanded');
            });
        });

        // 綁定巢狀內容的收合/展開 (json-collapsible)
        document.querySelectorAll('#results-tree-view .json-collapsible > .document-header').forEach(header => {
            header.addEventListener('click', function(e) {
                e.stopPropagation(); // 阻止事件冒泡到上層 document-item
                const parent = header.closest('.json-collapsible');
                parent.classList.toggle('expanded');
            });
        });
    }

    // --- 視圖切換邏輯 ---
    function toggleViewMode(newMode) {
        if (currentViewMode === newMode || !currentResults) return;

        currentViewMode = newMode;

        // 切換按鈕樣式
        tableViewBtn.classList.remove('active');
        treeViewBtn.classList.remove('active');
        document.getElementById(`${newMode}-view-btn`).classList.add('active');

        // 切換顯示區域
        if (newMode === 'table') {
            resultsTreeView.style.display = 'none';
            resultsTable.style.display = 'table';
            renderTable(currentResults.rows, currentResults.columnNames);
        } else {
            resultsTable.style.display = 'none';
            resultsTreeView.style.display = 'block';
            renderTreeView(currentResults.rows);
        }
    }

    // --- 載入邏輯 (保持與之前一致) ---

    async function fetchDatabases() {
        updateStatusMessage('正在載入資料庫列表...', 'info');
        clearResultsArea();
        try {
            const response = await fetch(DATABASES_URL, getRequestOptions());
            const apiResponse = await response.json();

            if (apiResponse.code !== "0") {
                updateStatusMessage(`載入資料庫失敗: ${apiResponse.message || '未知錯誤'}`, 'error');
                return;
            }

            const databases = apiResponse.data || [];
            if (databases.length === 0) {
                updateStatusMessage('未找到任何資料庫。', 'info');
                databaseSelect.innerHTML = '<option value="">無資料庫</option>';
                return;
            }

            let optionsHtml = '<option value="" disabled selected>— 請選擇資料庫 —</option>';
            optionsHtml += databases.map(db => `<option value="${db}">${db}</option>`).join('');
            databaseSelect.innerHTML = optionsHtml;

            updateStatusMessage('請選擇資料庫和集合，然後點擊「執行查詢」。', 'info');

        } catch (error) {
            console.error("Fetch Databases 失敗:", error);
            updateStatusMessage(`連線或網路錯誤: ${error.message}`, 'error');
        }
    }

    async function fetchCollections(databaseName) {
        if (!databaseName) return;

        collectionSelect.innerHTML = '<option value="">載入中...</option>';
        collectionSelect.disabled = true;

        try {
            const response = await fetch(COLLECTIONS_URL, getRequestOptions({ databaseName }));
            const apiResponse = await response.json();

            collectionSelect.disabled = false;

            if (apiResponse.code !== "0") {
                collectionSelect.innerHTML = `<option value="">載入失敗</option>`;
                updateStatusMessage(`載入集合失敗: ${apiResponse.message || '未知錯誤'}`, 'error');
                return;
            }

            const collections = apiResponse.data || [];
            if (collections.length === 0) {
                collectionSelect.innerHTML = '<option value="">無集合</option>';
                return;
            }

            let optionsHtml = '<option value="" disabled selected>— 請選擇集合 —</option>';
            optionsHtml += collections.map(col => `<option value="${col}">${col}</option>`).join('');
            collectionSelect.innerHTML = optionsHtml;

        } catch (error) {
            console.error("Fetch Collections 失敗:", error);
            collectionSelect.innerHTML = `<option value="">載入錯誤</option>`;
            collectionSelect.disabled = true;
            updateStatusMessage(`載入集合錯誤: ${error.message}`, 'error');
        }
    }

    async function executeQuery(page = 1) {
        currentDatabase = databaseSelect.value;
        currentCollection = collectionSelect.value;
        currentPage = page;

        if (!currentDatabase || !currentCollection) {
            updateStatusMessage('請先選擇資料庫和集合。', 'error');
            clearResultsArea();
            return;
        }

        const filter = filterInput.value.trim();
        const projection = projectionInput.value.trim();
        const sort = sortInput.value.trim();
        const size = parseInt(pageSizeInput.value, 10);

        // 檢查 JSON 格式
        if (!isValidJson(filter) || !isValidJson(projection) || !isValidJson(sort)) {
            updateStatusMessage('Filter, Projection 或 Sort 欄位格式不是有效的 JSON。', 'error');
            clearResultsArea();
            return;
        }

        loadingIndicator.style.display = 'inline';
        executeBtn.disabled = true;

        clearResultsArea();
        updateStatusMessage(`正在查詢 ${currentDatabase}.${currentCollection} 的第 ${currentPage} 頁...`, 'info');

        const requestBody = {
            databaseName: currentDatabase,
            collection: currentCollection,
            filter: filter === '{}' ? '' : filter,
            projection: projection === '{}' ? '' : projection,
            sort: sort === '{}' ? '' : sort,
            page: currentPage,
            size: size
        };

        try {
            const response = await fetch(QUERY_URL, getRequestOptions(requestBody));
            const apiResponse = await response.json();

            loadingIndicator.style.display = 'none';
            executeBtn.disabled = false;

            if (apiResponse.code !== "0") {
                const errorMessage = apiResponse.message || "查詢資料失敗";
                updateStatusMessage(`查詢失敗: ${errorMessage}`, 'error');
                clearResultsArea();
                return;
            }

            const result = apiResponse.data;
            currentResults = result;

            if (!result || !Array.isArray(result.rows)) {
                updateStatusMessage("API 回傳結構錯誤或 rows 欄位缺失。", 'error');
                clearResultsArea();
                return;
            }

            totalCount = result.totalCount || 0;
            const columnNames = result.columnNames || [];

            if (totalCount === 0 || columnNames.length === 0) {
                updateStatusMessage(`集合 ${currentDatabase}.${currentCollection} 無任何資料或查詢結果為空。`, 'info');
                clearResultsArea();
                return;
            }

            renderPaginationControls(size);
            viewModeControls.style.display = 'flex';

            if (currentViewMode === 'table') {
                renderTable(result.rows, columnNames);
            } else {
                renderTreeView(result.rows);
            }

            const totalPages = Math.ceil(totalCount / size);
            updateStatusMessage(`查詢成功：共 ${totalCount} 筆資料。當前頁面：${currentPage} / ${totalPages} (每頁 ${size} 筆)`, 'info');

        } catch (error) {
            loadingIndicator.style.display = 'none';
            executeBtn.disabled = false;
            console.error("MongoDB 查詢失敗:", error);
            updateStatusMessage(`連線或網路錯誤: ${error.message || '請檢查 API 服務'}`, 'error');
            clearResultsArea();
        }
    }

    function renderTable(rows, columnNames) {
        resultsTreeView.style.display = 'none';

        resultsHeader.innerHTML = columnNames.map(col => `<th>${escapeHtml(col)}</th>`).join('');

        const rowsHtml = rows.map(row => {
            const cellHtml = columnNames.map(col => {
                return `<td>${renderCellContent(row[col])}</td>`;
            }).join('');
            return `<tr>${cellHtml}</tr>`;
        }).join('');

        resultsBody.innerHTML = rowsHtml;
        resultsTable.style.display = 'table';
    }

    function renderPaginationControls(pageSize) {
        const totalPages = Math.ceil(totalCount / pageSize);
        paginationControls.innerHTML = '';
        paginationInfo.innerHTML = `共 ${totalCount} 筆 / ${totalPages} 頁`;

        if (totalPages <= 1) return;

        const prevBtn = document.createElement('button');
        prevBtn.textContent = '← 上一頁';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => executeQuery(currentPage - 1);
        paginationControls.appendChild(prevBtn);

        const currentSpan = document.createElement('span');
        currentSpan.textContent = `第 ${currentPage} 頁`;
        currentSpan.style.margin = '0 10px';
        currentSpan.style.fontWeight = 'bold';
        paginationControls.appendChild(currentSpan);


        const nextBtn = document.createElement('button');
        nextBtn.textContent = '下一頁 →';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => executeQuery(currentPage + 1);
        paginationControls.appendChild(nextBtn);
    }

    // --- 事件綁定 ---

    document.addEventListener("DOMContentLoaded", () => {
        // 首次載入資料庫
        fetchDatabases();

        // 資料庫變更事件
        databaseSelect.addEventListener("change", (event) => {
            currentDatabase = event.target.value;
            currentCollection = '';
            clearResultsArea();
            if (currentDatabase) {
                fetchCollections(currentDatabase);
            } else {
                collectionSelect.innerHTML = '<option value="">請選擇資料庫</option>';
                collectionSelect.disabled = true;
            }
        });

        // 執行查詢按鈕點擊事件
        executeBtn.addEventListener("click", () => {
            executeQuery(1);
        });

        // 頁面大小變動時，重新查詢第一頁
        pageSizeInput.addEventListener("change", () => {
            if (currentCollection) {
                executeQuery(1);
            }
        });

        // 視圖切換按鈕事件
        tableViewBtn.addEventListener('click', () => toggleViewMode('table'));
        treeViewBtn.addEventListener('click', () => toggleViewMode('tree'));
    });
</script>

</body>
</html>