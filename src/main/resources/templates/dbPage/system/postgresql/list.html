<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>資料表列表</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 0.5em;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #007BFF;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>

<div class="container">
    <h1>資料表列表</h1>

    <table>
        <thead>
        <tr>
            <th>資料表名稱</th>
            <th>描述</th>
        </tr>
        </thead>
        <tbody id="table-body">
        </tbody>
    </table>
</div>

<script>
    // 取得資料表列表並渲染到頁面
    function fetchAndRenderTables() {
        // 更新為新的 API URL
        const apiUrl = "http://localhost:8020/DBridge/api/postgresql/tables/metadata";
        const tableBody = document.getElementById("table-body");

        // 顯示載入中訊息
        tableBody.innerHTML = '<tr><td colspan="2">載入中…</td></tr>';

        // 使用 fetch API 呼叫後端
        fetch(apiUrl)
            .then(response => {
                // 檢查 HTTP 狀態碼
                if (!response.ok) {
                    throw new Error(`HTTP 錯誤! 狀態碼: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // 確保回傳的是陣列，避免錯誤
                if (!Array.isArray(data) || data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="2">無資料</td></tr>';
                    return;
                }

                // 將資料轉換成 HTML 字串，並插入到 tbody
                const rowsHtml = data.map(table => {
                    // 從物件中取得 tableName 和 remarks
                    const escapedName = escapeHtml(table.tableName);
                    // 檢查 remarks 是否為空，如果為空則顯示「—」
                    const remarks = table.remarks ? escapeHtml(table.remarks) : "—";
                    const detailPageUrl = `/templates/dbPage/system/postgresql/detail?tableName=${encodeURIComponent(table.tableName)}`;
                    return `
                        <tr>
                            <td><a href="${detailPageUrl}">${escapedName}</a></td>
                            <td>${remarks}</td>
                        </tr>
                    `;
                }).join('');

                tableBody.innerHTML = rowsHtml;
            })
            .catch(error => {
                // 處理連線或解析錯誤
                console.error("載入資料失敗:", error);
                tableBody.innerHTML = `<tr><td colspan="2">載入資料失敗</td></tr>`;
            });
    }

    // 簡化的 HTML 編碼函數，防止 XSS 攻擊
    function escapeHtml(s) {
        // 如果傳入 null 或 undefined，則回傳空字串
        if (s === null || typeof s === 'undefined') return '';
        return String(s).replace(/[&<>"']/g, c => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
        }[c]));
    }

    // 當頁面內容完全載入後，執行函式
    document.addEventListener("DOMContentLoaded", fetchAndRenderTables);
</script>

</body>
</html>