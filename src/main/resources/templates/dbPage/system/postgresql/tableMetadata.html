<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title id="page-title">è³‡æ–™è¡¨è©³æƒ…</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
      line-height: 1.6;
    }
    h1, h2, h3 {
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    .section-header {
      border-bottom: 2px solid #333;
      padding-bottom: 0.5em;
      margin-top: 2em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    /* çµ±ä¸€é€£çµæ¨£å¼ */
    .action-link {
      display: inline-block;
      margin-top: 2em;
      padding: 10px 15px;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      margin-right: 10px; /* å¢åŠ é–“éš” */
    }
    .action-link:hover {
      opacity: 0.9;
    }

    /* é‡å°ä¸‰å€‹é€£çµè¨­å®šä¸åŒé¡è‰² */
    #back-to-list-link {
      background-color: #007BFF;
    }
    #execute-sql-link {
      background-color: #28a745; /* ç¶ è‰² */
    }
    #view-data-link {
      background-color: #6c757d; /* ç°è‰² */
    }

  </style>
</head>
<body>
<div class="container">
  <h1 id="table-title">è³‡æ–™è¡¨è©³æƒ…</h1>

  <div id="loading-message">
    <p>è¼‰å…¥ä¸­...</p>
  </div>

  <div id="content" style="display: none;">
    <h3 class="section-header">è³‡æ–™è¡¨æè¿°</h3>
    <p id="table-remarks"></p>

    <h3 class="section-header">æ¬„ä½ï¼ˆColumnsï¼‰</h3>
    <table>
      <thead>
      <tr>
        <th>åç¨±</th>
        <th>å‹åˆ¥</th>
        <th>å¤§å°</th>
        <th>å¯å¦ç‚ºç©º</th>
        <th>é è¨­å€¼</th>
        <th>ä¸»éµ</th>
      </tr>
      </thead>
      <tbody id="columns-body"></tbody>
    </table>

    <h3 class="section-header">ç´„æŸï¼ˆConstraintsï¼‰</h3>
    <ul id="constraints-list"></ul>

    <a href="/DBridge/view/postgresql/tableList" id="back-to-list-link" class="action-link">â† è¿”å›è³‡æ–™è¡¨åˆ—è¡¨</a>

    <a href="#" id="execute-sql-link" class="action-link" target="_blank">âš¡ åŸ·è¡Œè‡ªè¨‚ SQL</a>

    <a href="#" id="view-data-link" class="action-link">ğŸ” æª¢è¦–è³‡æ–™</a>
  </div>
</div>

<script>
  const API_BASE_URL = "http://localhost:8020/DBridge/api/postgresql";
  const SQL_EXECUTE_URL = "http://localhost:8020/DBridge/view/postgresql/sqlExecute";

  // å–å¾— URL åƒæ•¸
  const urlParams = new URLSearchParams(window.location.search);
  const tableName = urlParams.get('tableName');
  const tableSchema = urlParams.get('schema');

  // æª¢æŸ¥ URL åƒæ•¸
  if (!tableName || !tableSchema) {
    document.getElementById("loading-message").innerHTML = "<p>éŒ¯èª¤ï¼šç¼ºå°‘è³‡æ–™è¡¨æˆ– Schema åç¨±ã€‚</p>";
    throw new Error("Missing tableName or schema parameter.");
  }

  // è¼‰å…¥è³‡æ–™è¡¨ Metadata
  function fetchTableMetadata() {
    const apiUrl = `${API_BASE_URL}/table/metadata`;

    fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ schema: tableSchema, tableName: tableName })
    })
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
              }
              return response.json();
            })
            .then(apiResponse => {
              if (apiResponse.code !== "0") {
                const errorMessage = apiResponse.message || "è¼‰å…¥è³‡æ–™å¤±æ•—";
                document.getElementById("loading-message").innerHTML = `<p>éŒ¯èª¤: ${errorMessage}</p>`;
                return;
              }

              const data = apiResponse.data;
              if (!data) {
                document.getElementById("loading-message").innerHTML = `<p>æ‰¾ä¸åˆ°è³‡æ–™è¡¨ ${tableName} çš„è©³ç´°è³‡è¨Šã€‚</p>`;
                return;
              }

              // éš±è—è¼‰å…¥è¨Šæ¯ï¼Œé¡¯ç¤ºå…§å®¹
              document.getElementById("loading-message").style.display = 'none';
              document.getElementById("content").style.display = 'block';

              // å¡«å……åŸºæœ¬è³‡è¨Š
              document.getElementById("page-title").textContent = `è³‡æ–™è¡¨è©³æƒ…ï¼š${data.tableName}`;
              document.getElementById("table-title").textContent = `è³‡æ–™è¡¨è©³æƒ…ï¼š${data.tableName} (${tableSchema})`;
              document.getElementById("table-remarks").textContent = data.remarks || "ç„¡æè¿°";

              // å¡«å……æ¬„ä½è¡¨æ ¼
              const columnsBody = document.getElementById("columns-body");
              if (Array.isArray(data.columns) && data.columns.length > 0) {
                const columnsHtml = data.columns.map(col => `
                        <tr>
                            <td>${escapeHtml(col.columnName)}</td>
                            <td>${escapeHtml(col.dataType)}</td>
                            <td>${col.columnSize || "â€”"}</td>
                            <td>${col.nullable.displayName || "â€”"}</td>
                            <td>${col.defaultValue || "â€”"}</td>
                            <td>${col.primaryKey ? 'âœ”' : ''}</td>
                        </tr>
                    `).join('');
                columnsBody.innerHTML = columnsHtml;
              } else {
                columnsBody.innerHTML = '<tr><td colspan="6">ç„¡æ¬„ä½è³‡è¨Š</td></tr>';
              }

              // å¡«å……ç´„æŸåˆ—è¡¨
              const constraintsList = document.getElementById("constraints-list");
              if (Array.isArray(data.constraints) && data.constraints.length > 0) {
                const constraintsHtml = data.constraints.map(c => `
                        <li>[${c.constraintType.displayName}] ${c.constraintName} - ${c.checkClause || "â€”"}</li>
                    `).join('');
                constraintsList.innerHTML = constraintsHtml;
              } else {
                constraintsList.innerHTML = '<li>ç„¡ä»»ä½•ç´„æŸ</li>';
              }

              // å–å¾—é€£çµå…ƒç´ 
              const viewDataLink = document.getElementById("view-data-link");
              const backToListLink = document.getElementById("back-to-list-link");
              const executeSqlLink = document.getElementById("execute-sql-link");

              // è¨­å®šé€£çµçš„ href å±¬æ€§
              backToListLink.href = `/DBridge/view/postgresql/tableList?schema=${encodeURIComponent(tableSchema)}`;
              executeSqlLink.href = `${SQL_EXECUTE_URL}?schema=${encodeURIComponent(tableSchema)}`;
              viewDataLink.href = `/DBridge/view/postgresql/tableData?tableName=${encodeURIComponent(data.tableName)}&schema=${encodeURIComponent(tableSchema)}`;

            })
            .catch(error => {
              console.error("è¼‰å…¥è³‡æ–™å¤±æ•—:", error);
              document.getElementById("loading-message").innerHTML = `<p>è¼‰å…¥è³‡æ–™å¤±æ•—</p>`;
            });
  }

  // ç°¡åŒ–çš„ HTML ç·¨ç¢¼å‡½æ•¸
  function escapeHtml(s) {
    if (s === null || typeof s === 'undefined') return '';
    return String(s).replace(/[&<>"']/g, c => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[c]));
  }

  document.addEventListener("DOMContentLoaded", fetchTableMetadata);
</script>
</body>
</html>