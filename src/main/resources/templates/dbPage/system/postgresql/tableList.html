<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>資料表列表</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 0.5em;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #007BFF;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .controls {
            margin-bottom: 1em;
        }
        /* 新增的樣式 */
        label {
            font-weight: bold;
            color: #333;
            margin-right: 10px;
        }
        #schema-select {
            padding: 8px 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            color: #333;
            cursor: pointer;
        }
        #schema-select:hover {
            border-color: #a0a0a0;
        }
        #schema-select:focus {
            outline: none;
            border-color: #007BFF;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.25);
        }
    </style>
</head>

<body>

<div class="container">
    <h1>資料表列表</h1>

    <div class="controls">
        <label for="schema-select">選擇 Schema:</label>
        <select id="schema-select"></select>
    </div>

    <table>
        <thead>
        <tr>
            <th>資料表名稱</th>
            <th>描述</th>
        </tr>
        </thead>
        <tbody id="table-body">
        </tbody>
    </table>
</div>

<script>
    const API_BASE_URL = "http://localhost:8020/DBridge/api/postgresql";

    // 取得資料表列表並渲染到頁面 (此函數邏輯保持不變)
    function fetchAndRenderTables(schema) {
        const apiUrl = `${API_BASE_URL}/tables/metadata`;
        const tableBody = document.getElementById("table-body");

        tableBody.innerHTML = '<tr><td colspan="2">載入中…</td></tr>';

        if (!schema) {
            tableBody.innerHTML = '<tr><td colspan="2">請選擇一個 Schema</td></tr>';
            return;
        }

        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ schema: schema })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP 錯誤! 狀態碼: ${response.status}`);
                }
                return response.json();
            })
            .then(apiResponse => {
                if (apiResponse.code !== "0") {
                    const errorMessage = apiResponse.message || "未知錯誤";
                    tableBody.innerHTML = `<tr><td colspan="2">錯誤: ${errorMessage}</td></tr>`;
                    return;
                }

                const data = apiResponse.data;

                if (!Array.isArray(data) || data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="2">無資料</td></tr>';
                    return;
                }

                const rowsHtml = data.map(table => {
                    const escapedName = escapeHtml(table.tableName);
                    const remarks = table.remarks ? escapeHtml(table.remarks) : "—";

                    // URL 必須使用當前選中的 schema 變數
                    const detailPageUrl = `/DBridge/view/postgresql/tableMetadata?schema=${encodeURIComponent(schema)}&tableName=${encodeURIComponent(table.tableName)}`;

                    return `
                        <tr>
                            <td><a href="${detailPageUrl}">${escapedName}</a></td>
                            <td>${remarks}</td>
                        </tr>
                    `;
                }).join('');

                tableBody.innerHTML = rowsHtml;
            })
            .catch(error => {
                console.error("載入資料失敗:", error);
                tableBody.innerHTML = `<tr><td colspan="2">載入資料失敗</td></tr>`;
            });
    }

    // 取得 Schema 列表並填充下拉式選單
    // ✅ 核心變動：接受一個 defaultSchemaName 參數，用於預選
    function fetchSchemasAndPopulateDropdown(defaultSchemaName) {
        const schemasUrl = `${API_BASE_URL}/schemas`;
        const selectElement = document.getElementById("schema-select");
        let initialSchemaToLoad = null;

        fetch(schemasUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
            .then(response => response.json())
            .then(apiResponse => {
                if (apiResponse.code !== "0") {
                    console.error("載入 Schema 列表失敗:", apiResponse.message);
                    selectElement.innerHTML = '<option value="">載入失敗</option>';
                    return;
                }

                const schemas = apiResponse.data;
                if (!Array.isArray(schemas) || schemas.length === 0) {
                    selectElement.innerHTML = '<option value="">無 Schema 可選</option>';
                    return;
                }

                // 1. 根據 API 回傳的 Schema 列表建立 Option
                const optionsHtml = schemas.map(schema => {
                    const escapedSchema = escapeHtml(schema);
                    let selectedAttr = '';

                    // 2. 檢查是否與 URL 傳入的預設 Schema 相符
                    if (defaultSchemaName && schema === defaultSchemaName) {
                        selectedAttr = ' selected';
                        initialSchemaToLoad = schema; // 記住要載入的 Schema
                    }

                    return `<option value="${escapedSchema}"${selectedAttr}>${escapedSchema}</option>`;
                }).join('');

                selectElement.innerHTML = optionsHtml;

                // 3. 確定最終要載入的 Schema：
                //    - 如果 URL 有傳，就載入 URL 傳入的 (initialSchemaToLoad)
                //    - 如果 URL 沒傳，就載入列表中的第一個 (selectElement.value)
                const schemaToLoad = initialSchemaToLoad || selectElement.value;

                // 4. 首次載入頁面時，使用確定的 schema
                fetchAndRenderTables(schemaToLoad);

            })
            .catch(error => {
                console.error("載入 Schema 列表失敗:", error);
                selectElement.innerHTML = '<option value="">載入失敗</option>';
            });
    }

    function escapeHtml(s) {
        if (s === null || typeof s === 'undefined') return '';

        return String(s).replace(/[&<>"']/g, c => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
        }[c]));
    }

    // ✅ 核心啟動邏輯：完全由前端 JavaScript 負責讀取 URL 參數
    document.addEventListener("DOMContentLoaded", () => {
        // 使用 URLSearchParams 原生物件讀取 URL 參數
        const urlParams = new URLSearchParams(window.location.search);

        // 取得 URL 中名為 'schema' 的參數值 (例如: ?schema=public)
        const initialSchema = urlParams.get('schema');

        // 1. 載入 Schema 列表，並傳入從 URL 讀取的參數進行預選
        //    如果 URL 沒有參數，則傳入 null
        fetchSchemasAndPopulateDropdown(initialSchema);

        // 2. 設置下拉選單的變動事件
        const selectElement = document.getElementById("schema-select");
        selectElement.addEventListener("change", (event) => {
            // 當使用者切換 Schema 時，更新表格
            fetchAndRenderTables(event.target.value);

            // 💡 UX 建議：同時更新瀏覽器的 URL，這樣使用者才能將當前頁面加入書籤
            if (event.target.value) {
                const newUrl = `${window.location.pathname}?schema=${encodeURIComponent(event.target.value)}`;
                window.history.pushState({ path: newUrl }, '', newUrl);
            } else {
                window.history.pushState({ path: window.location.pathname }, '', window.location.pathname);
            }
        });
    });
</script>

</body>
</html>