<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>è³‡æ–™è¡¨åˆ—è¡¨</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 0.5em;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #007BFF;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .controls {
            margin-bottom: 1em;
        }
        /* æ–°å¢çš„æ¨£å¼ */
        label {
            font-weight: bold;
            color: #333;
            margin-right: 10px;
        }
        #schema-select {
            padding: 8px 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            color: #333;
            cursor: pointer;
        }
        #schema-select:hover {
            border-color: #a0a0a0;
        }
        #schema-select:focus {
            outline: none;
            border-color: #007BFF;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.25);
        }
    </style>
</head>

<body>

<div class="container">
    <h1>è³‡æ–™è¡¨åˆ—è¡¨</h1>

    <div class="controls">
        <label for="schema-select">é¸æ“‡ Schema:</label>
        <select id="schema-select"></select>
    </div>

    <table>
        <thead>
        <tr>
            <th>è³‡æ–™è¡¨åç¨±</th>
            <th>æè¿°</th>
        </tr>
        </thead>
        <tbody id="table-body">
        </tbody>
    </table>
</div>

<script>
    const API_BASE_URL = "http://localhost:8020/DBridge/api/postgresql";

    // å–å¾—è³‡æ–™è¡¨åˆ—è¡¨ä¸¦æ¸²æŸ“åˆ°é é¢ (æ­¤å‡½æ•¸é‚è¼¯ä¿æŒä¸è®Š)
    function fetchAndRenderTables(schema) {
        const apiUrl = `${API_BASE_URL}/tables/metadata`;
        const tableBody = document.getElementById("table-body");

        tableBody.innerHTML = '<tr><td colspan="2">è¼‰å…¥ä¸­â€¦</td></tr>';

        if (!schema) {
            tableBody.innerHTML = '<tr><td colspan="2">è«‹é¸æ“‡ä¸€å€‹ Schema</td></tr>';
            return;
        }

        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ schema: schema })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
                }
                return response.json();
            })
            .then(apiResponse => {
                if (apiResponse.code !== "0") {
                    const errorMessage = apiResponse.message || "æœªçŸ¥éŒ¯èª¤";
                    tableBody.innerHTML = `<tr><td colspan="2">éŒ¯èª¤: ${errorMessage}</td></tr>`;
                    return;
                }

                const data = apiResponse.data;

                if (!Array.isArray(data) || data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="2">ç„¡è³‡æ–™</td></tr>';
                    return;
                }

                const rowsHtml = data.map(table => {
                    const escapedName = escapeHtml(table.tableName);
                    const remarks = table.remarks ? escapeHtml(table.remarks) : "â€”";

                    // URL å¿…é ˆä½¿ç”¨ç•¶å‰é¸ä¸­çš„ schema è®Šæ•¸
                    const detailPageUrl = `/DBridge/view/postgresql/tableMetadata?schema=${encodeURIComponent(schema)}&tableName=${encodeURIComponent(table.tableName)}`;

                    return `
                        <tr>
                            <td><a href="${detailPageUrl}">${escapedName}</a></td>
                            <td>${remarks}</td>
                        </tr>
                    `;
                }).join('');

                tableBody.innerHTML = rowsHtml;
            })
            .catch(error => {
                console.error("è¼‰å…¥è³‡æ–™å¤±æ•—:", error);
                tableBody.innerHTML = `<tr><td colspan="2">è¼‰å…¥è³‡æ–™å¤±æ•—</td></tr>`;
            });
    }

    // å–å¾— Schema åˆ—è¡¨ä¸¦å¡«å……ä¸‹æ‹‰å¼é¸å–®
    // âœ… æ ¸å¿ƒè®Šå‹•ï¼šæ¥å—ä¸€å€‹ defaultSchemaName åƒæ•¸ï¼Œç”¨æ–¼é é¸
    function fetchSchemasAndPopulateDropdown(defaultSchemaName) {
        const schemasUrl = `${API_BASE_URL}/schemas`;
        const selectElement = document.getElementById("schema-select");
        let initialSchemaToLoad = null;

        fetch(schemasUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
            .then(response => response.json())
            .then(apiResponse => {
                if (apiResponse.code !== "0") {
                    console.error("è¼‰å…¥ Schema åˆ—è¡¨å¤±æ•—:", apiResponse.message);
                    selectElement.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                    return;
                }

                const schemas = apiResponse.data;
                if (!Array.isArray(schemas) || schemas.length === 0) {
                    selectElement.innerHTML = '<option value="">ç„¡ Schema å¯é¸</option>';
                    return;
                }

                // 1. æ ¹æ“š API å›å‚³çš„ Schema åˆ—è¡¨å»ºç«‹ Option
                const optionsHtml = schemas.map(schema => {
                    const escapedSchema = escapeHtml(schema);
                    let selectedAttr = '';

                    // 2. æª¢æŸ¥æ˜¯å¦èˆ‡ URL å‚³å…¥çš„é è¨­ Schema ç›¸ç¬¦
                    if (defaultSchemaName && schema === defaultSchemaName) {
                        selectedAttr = ' selected';
                        initialSchemaToLoad = schema; // è¨˜ä½è¦è¼‰å…¥çš„ Schema
                    }

                    return `<option value="${escapedSchema}"${selectedAttr}>${escapedSchema}</option>`;
                }).join('');

                selectElement.innerHTML = optionsHtml;

                // 3. ç¢ºå®šæœ€çµ‚è¦è¼‰å…¥çš„ Schemaï¼š
                //    - å¦‚æœ URL æœ‰å‚³ï¼Œå°±è¼‰å…¥ URL å‚³å…¥çš„ (initialSchemaToLoad)
                //    - å¦‚æœ URL æ²’å‚³ï¼Œå°±è¼‰å…¥åˆ—è¡¨ä¸­çš„ç¬¬ä¸€å€‹ (selectElement.value)
                const schemaToLoad = initialSchemaToLoad || selectElement.value;

                // 4. é¦–æ¬¡è¼‰å…¥é é¢æ™‚ï¼Œä½¿ç”¨ç¢ºå®šçš„ schema
                fetchAndRenderTables(schemaToLoad);

            })
            .catch(error => {
                console.error("è¼‰å…¥ Schema åˆ—è¡¨å¤±æ•—:", error);
                selectElement.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
            });
    }

    function escapeHtml(s) {
        if (s === null || typeof s === 'undefined') return '';

        return String(s).replace(/[&<>"']/g, c => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
        }[c]));
    }

    // âœ… æ ¸å¿ƒå•Ÿå‹•é‚è¼¯ï¼šå®Œå…¨ç”±å‰ç«¯ JavaScript è² è²¬è®€å– URL åƒæ•¸
    document.addEventListener("DOMContentLoaded", () => {
        // ä½¿ç”¨ URLSearchParams åŸç”Ÿç‰©ä»¶è®€å– URL åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);

        // å–å¾— URL ä¸­åç‚º 'schema' çš„åƒæ•¸å€¼ (ä¾‹å¦‚: ?schema=public)
        const initialSchema = urlParams.get('schema');

        // 1. è¼‰å…¥ Schema åˆ—è¡¨ï¼Œä¸¦å‚³å…¥å¾ URL è®€å–çš„åƒæ•¸é€²è¡Œé é¸
        //    å¦‚æœ URL æ²’æœ‰åƒæ•¸ï¼Œå‰‡å‚³å…¥ null
        fetchSchemasAndPopulateDropdown(initialSchema);

        // 2. è¨­ç½®ä¸‹æ‹‰é¸å–®çš„è®Šå‹•äº‹ä»¶
        const selectElement = document.getElementById("schema-select");
        selectElement.addEventListener("change", (event) => {
            // ç•¶ä½¿ç”¨è€…åˆ‡æ› Schema æ™‚ï¼Œæ›´æ–°è¡¨æ ¼
            fetchAndRenderTables(event.target.value);

            // ğŸ’¡ UX å»ºè­°ï¼šåŒæ™‚æ›´æ–°ç€è¦½å™¨çš„ URLï¼Œé€™æ¨£ä½¿ç”¨è€…æ‰èƒ½å°‡ç•¶å‰é é¢åŠ å…¥æ›¸ç±¤
            if (event.target.value) {
                const newUrl = `${window.location.pathname}?schema=${encodeURIComponent(event.target.value)}`;
                window.history.pushState({ path: newUrl }, '', newUrl);
            } else {
                window.history.pushState({ path: window.location.pathname }, '', window.location.pathname);
            }
        });
    });
</script>

</body>
</html>