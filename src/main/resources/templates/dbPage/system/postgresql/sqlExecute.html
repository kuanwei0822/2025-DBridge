<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸ·è¡Œè‡ªè¨‚ SQL</title>

    <th:block th:if="${_csrf}">
        <meta name="_csrf" th:content="${_csrf.token}"/>
        <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    </th:block>

    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
            line-height: 1.6;
            background-color: #f4f7f6; /* èˆ‡èƒŒæ™¯åœ–ç›¸ä¼¼çš„æ·ºç° */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #4b6cb7;
            border-bottom: 2px solid #4b6cb7;
            padding-bottom: 0.5em;
            text-align: center;
            margin-bottom: 1.5em;
        }
        .controls {
            margin-bottom: 1em;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        label {
            font-weight: bold;
            color: #333;
        }
        #schema-select, #page-size-select {
            padding: 8px 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            color: #333;
            cursor: pointer;
        }
        #schema-select:focus, #page-size-select:focus {
            outline: none;
            border-color: #007BFF;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.25);
        }
        .sql-editor-container {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f9f9f9;
        }
        #sql-textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            box-sizing: border-box;
            border: none;
            resize: vertical;
            font-family: monospace;
            font-size: 14px;
            outline: none;
            background-color: #f9f9f9;
        }
        #execute-btn {
            background-color: #4b6cb7;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: block;
            width: 100%;
        }
        #execute-btn:hover {
            background-color: #3f5a9e;
        }
        .results-container {
            margin-top: 30px;
        }
        h2 {
            color: #333;
            font-size: 1.5em;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 5px;
        }
        .message-box {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-weight: bold;
            word-break: break-all;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }
        #results-table th, #results-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-break: break-all;
        }
        #results-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        #results-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .pagination button {
            padding: 8px 12px;
            margin: 0 5px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .pagination button:hover:not(:disabled) {
            background-color: #e0e0e0;
        }
        .pagination button.active {
            background-color: #4b6cb7;
            color: white;
            border-color: #4b6cb7;
        }
    </style>
</head>

<body>

<div class="container">
    <h1>åŸ·è¡Œè‡ªè¨‚ SQL</h1>

    <div class="controls">
        <label for="schema-select">é¸æ“‡ Search Path (Schema):</label>
        <select id="schema-select"></select>
        <span id="loading-schemas-message" style="color: #666;">è¼‰å…¥ Schema...</span>

        <label for="page-size-select">æ¯é é¡¯ç¤º:</label>
        <select id="page-size-select">
            <option value="10">10 ç­†</option>
            <option value="25">25 ç­†</option>
            <option value="50" selected>50 ç­†</option>
            <option value="100">100 ç­†</option>
            <option value="200">200 ç­†</option>
            <option value="500">500 ç­†</option>
        </select>
    </div>

    <div class="sql-editor-container">
        <textarea id="sql-textarea" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„ SQL èªå¥ (ä¾‹å¦‚: SELECT * FROM users LIMIT 10)ã€‚æœªæŒ‡å®š Schema çš„è³‡æ–™è¡¨å°‡ä»¥é¸ä¸­çš„ Search Path ç‚ºæº–ã€‚"></textarea>
    </div>
    <button id="execute-btn">åŸ·è¡Œ SQL</button>

    <div class="results-container">
        <h2>æŸ¥è©¢çµæœèˆ‡è¨Šæ¯</h2>
        <div id="message-area" class="message-box">
            è«‹é¸æ“‡ Search Path ä¸¦é»æ“Šã€ŒåŸ·è¡Œ SQLã€ã€‚
        </div>

        <table id="results-table" style="display: none;">
            <thead>
            <tr id="results-header"></tr>
            </thead>
            <tbody id="results-body"></tbody>
        </table>

        <div id="pagination-controls" class="pagination" style="margin-top: 15px; text-align: center;">
        </div>
    </div>

</div>

<script>
    const API_BASE_URL = "/DBridge/api/postgresql";
    const SQL_EXECUTE_URL = `${API_BASE_URL}/sqlExecute`;
    const SCHEMAS_URL = `${API_BASE_URL}/schemas`;

    // ğŸ’¡ æ­¥é©Ÿ 2: ç²å– CSRF Token å’Œ Header åç¨±
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');


    const sqlTextarea = document.getElementById("sql-textarea");
    const executeBtn = document.getElementById("execute-btn");
    const messageArea = document.getElementById("message-area");
    const resultsTable = document.getElementById("results-table");
    const resultsHeader = document.getElementById("results-header");
    const resultsBody = document.getElementById("results-body");
    const selectElement = document.getElementById("schema-select");
    const loadingMessage = document.getElementById("loading-schemas-message");
    const paginationControls = document.getElementById("pagination-controls");
    const pageSizeSelect = document.getElementById("page-size-select");

    let ROWS_PER_PAGE = parseInt(pageSizeSelect.value, 10);
    let allResults = [];
    let currentPage = 1;

    // ğŸ’¡ æ­¥é©Ÿ 3: è¼”åŠ©å‡½æ•¸ - å–å¾—å¸¶æœ‰ CSRF Header çš„è«‹æ±‚è¨­å®š
    function getRequestOptions(bodyData) {
        const options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(bodyData)
        };

        // å¦‚æœ CSRF Token å­˜åœ¨ï¼Œå°±å°‡å…¶åŠ å…¥åˆ° Headers ä¸­
        if (csrfToken && csrfHeader) {
            options.headers[csrfHeader] = csrfToken;
        }
        return options;
    }


    // è¼”åŠ©å‡½æ•¸ï¼šé¡¯ç¤ºè¨Šæ¯
    function displayMessage(message, type = 'info') {
        messageArea.textContent = message;
        messageArea.className = `message-box ${type === 'success' ? 'success' : type === 'error' ? 'error' : ''}`;
        resultsTable.style.display = 'none';
        resultsHeader.innerHTML = '';
        resultsBody.innerHTML = '';
        paginationControls.innerHTML = ''; // æ¸…ç©ºåˆ†é æ§åˆ¶é …
    }

    // è¼”åŠ©å‡½æ•¸ï¼šHTML ç·¨ç¢¼
    function escapeHtml(s) {
        if (s === null || typeof s === 'undefined') return '';
        return String(s).replace(/[&<>"']/g, c => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
        }[c]));
    }

    // æ¸²æŸ“ç•¶å‰é é¢çš„è¡¨æ ¼è³‡æ–™
    function renderTablePage(page) {
        currentPage = page;
        const startIndex = (page - 1) * ROWS_PER_PAGE;
        const endIndex = startIndex + ROWS_PER_PAGE;
        const pageRows = allResults.slice(startIndex, endIndex);

        const columns = allResults.length > 0 ? Object.keys(allResults[0]) : [];

        // æ¸²æŸ“ Table Body
        const rowsHtml = pageRows.map(row => {
            const cellHtml = columns.map(col => `<td>${escapeHtml(row[col])}</td>`).join('');
            return `<tr>${cellHtml}</tr>`;
        }).join('');
        resultsBody.innerHTML = rowsHtml;

        // æ¸²æŸ“åˆ†é æ§åˆ¶é …
        renderPaginationControls();
    }

    // æ¸²æŸ“åˆ†é æ§åˆ¶æŒ‰éˆ•
    function renderPaginationControls() {
        const totalRows = allResults.length;
        const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);

        if (totalPages <= 1) {
            paginationControls.innerHTML = '';
            return;
        }

        let controlsHtml = '';

        // ä¸Šä¸€é æŒ‰éˆ•
        controlsHtml += `<button id="prev-btn" ${currentPage === 1 ? 'disabled' : ''}>â† ä¸Šä¸€é </button>`;

        // é ç¢¼æŒ‰éˆ•
        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        if (endPage - startPage + 1 < maxButtons) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        const pageNumbersToShow = new Set();
        pageNumbersToShow.add(1);
        for (let i = startPage; i <= endPage; i++) {
            pageNumbersToShow.add(i);
        }
        pageNumbersToShow.add(totalPages);

        const sortedPages = Array.from(pageNumbersToShow).sort((a, b) => a - b);
        let lastPage = 0;

        sortedPages.forEach(i => {
            if (i - lastPage > 1) {
                controlsHtml += `<span style="margin: 0 5px;">...</span>`;
            }
            const activeClass = i === currentPage ? 'active' : '';
            controlsHtml += `<button class="${activeClass}" onclick="renderTablePage(${i})">${i}</button>`;
            lastPage = i;
        });

        // ä¸‹ä¸€é æŒ‰éˆ•
        controlsHtml += `<button id="next-btn" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é  â†’</button>`;

        paginationControls.innerHTML = controlsHtml;

        // ç¶å®šä¸Šä¸‹é æŒ‰éˆ•äº‹ä»¶
        document.getElementById('prev-btn').onclick = () => {
            if (currentPage > 1) renderTablePage(currentPage - 1);
        };
        document.getElementById('next-btn').onclick = () => {
            if (currentPage < totalPages) renderTablePage(currentPage + 1);
        };
    }


    // å–å¾— Schema åˆ—è¡¨ä¸¦å¡«å……ä¸‹æ‹‰å¼é¸å–® (POST API)
    function fetchSchemasAndPopulateDropdown(defaultSchemaName) {
        loadingMessage.style.display = 'inline';

        // ğŸ’¡ æ­¥é©Ÿ 4: ä½¿ç”¨ getRequestOptions æ›¿æ›èˆŠçš„ fetch åƒæ•¸
        fetch(SCHEMAS_URL, getRequestOptions({}))
            .then(response => response.json())
            .then(apiResponse => {
                loadingMessage.style.display = 'none';
                if (apiResponse.code !== "0") {
                    console.error("è¼‰å…¥ Schema åˆ—è¡¨å¤±æ•—:", apiResponse.message);
                    selectElement.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                    displayMessage("è¼‰å…¥ Schema åˆ—è¡¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API é€£ç·šã€‚", 'error');
                    return;
                }

                const schemas = apiResponse.data;
                if (!Array.isArray(schemas) || schemas.length === 0) {
                    selectElement.innerHTML = '<option value="">ç„¡ Schema å¯é¸</option>';
                    displayMessage("API æœªå›å‚³ä»»ä½•å¯ç”¨çš„ Schemaã€‚", 'error');
                    return;
                }

                let schemaToSelect = null;

                const optionsHtml = schemas.map((schema, index) => {
                    const escapedSchema = escapeHtml(schema);
                    let selectedAttr = '';

                    // 1. æª¢æŸ¥æ˜¯å¦èˆ‡ URL å‚³å…¥çš„é è¨­ Schema ç›¸ç¬¦
                    if (defaultSchemaName && schema === defaultSchemaName) {
                        selectedAttr = ' selected';
                        schemaToSelect = schema;
                    }
                    // 2. å¦‚æœ URL åƒæ•¸ä¸ç¬¦åˆæˆ–ä¸å­˜åœ¨ï¼Œå‰‡é¸å–ç¬¬ä¸€å€‹ (index === 0)
                    else if (!schemaToSelect && index === 0) {
                        schemaToSelect = schema;
                        selectedAttr = ' selected';
                    }

                    return `<option value="${escapedSchema}"${selectedAttr}>${escapedSchema}</option>`;
                }).join('');

                selectElement.innerHTML = optionsHtml;

                if (schemaToSelect) {
                    displayMessage(`å·²é¸ä¸­ Search Path: ${schemaToSelect}ã€‚è«‹è¼¸å…¥ SQL èªå¥ã€‚`);
                } else {
                    displayMessage("è«‹é¸æ“‡ä¸€å€‹ Search Path (Schema)ã€‚", 'error');
                }
            })
            .catch(error => {
                loadingMessage.style.display = 'none';
                console.error("è¼‰å…¥ Schema åˆ—è¡¨å¤±æ•—:", error);
                selectElement.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                displayMessage("ç„¡æ³•é€£ç·šåˆ° Schema åˆ—è¡¨ APIã€‚", 'error');
            });
    }


    // ä¸»é‚è¼¯ï¼šåŸ·è¡Œ SQL æŸ¥è©¢ (POST API)
    async function executeSql() {
        const sqlStatement = sqlTextarea.value.trim();
        const currentSchema = selectElement.value;

        if (!currentSchema || !sqlStatement) {
            displayMessage(`è«‹å…ˆ${!currentSchema ? 'é¸æ“‡ Search Path' : 'è¼¸å…¥ SQL èªå¥'}ã€‚`, 'error');
            return;
        }

        executeBtn.disabled = true;
        displayMessage("åŸ·è¡Œä¸­...", 'info');

        const requestBody = { schema: currentSchema, sqlStatement: sqlStatement };

        try {
            // ğŸ’¡ æ­¥é©Ÿ 5: ä½¿ç”¨ getRequestOptions æ›¿æ›èˆŠçš„ fetch åƒæ•¸
            const response = await fetch(SQL_EXECUTE_URL, getRequestOptions(requestBody));

            const apiResponse = await response.json();

            if (apiResponse.code !== "0") {
                const errorMessage = apiResponse.data && apiResponse.data.message
                    ? apiResponse.data.message
                    : apiResponse.message || "åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ SQL èªæ³•æˆ–é€£ç·šã€‚";
                throw new Error(errorMessage);
            }

            const data = apiResponse.data;

            if (!data) {
                displayMessage(apiResponse.message || "æ“ä½œæˆåŠŸï¼Œä½† API å›å‚³æ•¸æ“šçµæ§‹éŒ¯èª¤ã€‚", 'error');
                return;
            }

            if (data.type === 'UPDATE_COUNT') {
                displayMessage(`åŸ·è¡ŒæˆåŠŸï¼šå½±éŸ¿ ${data.count || 0} ç­†è³‡æ–™ã€‚`, 'success');

            } else if (data.type === 'SELECT_RESULT' && Array.isArray(data.rows)) {

                // 1. å„²å­˜å®Œæ•´çµæœé›†
                allResults = data.rows;

                if (allResults.length === 0) {
                    displayMessage("æŸ¥è©¢æˆåŠŸï¼Œä½†ç„¡è³‡æ–™ã€‚", 'success');
                    return;
                }

                // 2. æ¸²æŸ“è¡¨é ­ (åªéœ€æ¸²æŸ“ä¸€æ¬¡)
                const columns = Object.keys(allResults[0]);
                resultsHeader.innerHTML = columns.map(col => `<th>${escapeHtml(col)}</th>`).join('');

                // 3. æ¸²æŸ“ç¬¬ä¸€é ä¸¦åˆå§‹åŒ–åˆ†é æ§åˆ¶
                renderTablePage(1);
                resultsTable.style.display = 'table';

                // 4. æ›´æ–°è¨Šæ¯å€
                messageArea.textContent = `æŸ¥è©¢æˆåŠŸï¼šå…± ${allResults.length} ç­†çµæœã€‚æ¯é é¡¯ç¤º ${ROWS_PER_PAGE} ç­†ã€‚`;
                messageArea.className = 'message-box success';

            } else {
                displayMessage(data.message || apiResponse.message || "æ“ä½œæˆåŠŸï¼Œä½† API å›å‚³æ ¼å¼ä¸ç¬¦é æœŸã€‚", 'info');
            }

        } catch (error) {
            console.error("SQL åŸ·è¡Œå¤±æ•—:", error);
            displayMessage(`SQL åŸ·è¡Œå¤±æ•—: ${error.message || 'é€£ç·šéŒ¯èª¤'}`, 'error');
        } finally {
            executeBtn.disabled = false;
        }
    }

    // æ ¸å¿ƒå•Ÿå‹•é‚è¼¯
    document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const initialSchema = urlParams.get('schema');

        fetchSchemasAndPopulateDropdown(initialSchema);

        // 2. è¨­ç½® Schema ä¸‹æ‹‰é¸å–®çš„è®Šå‹•äº‹ä»¶
        selectElement.addEventListener("change", (event) => {
            const newSchema = event.target.value;
            const newUrl = `${window.location.pathname}?schema=${encodeURIComponent(newSchema)}`;
            window.history.pushState({ path: newUrl }, '', newUrl);

            displayMessage(`å·²åˆ‡æ› Search Path ç‚º: ${newSchema}ã€‚è«‹åŸ·è¡Œ SQL èªå¥ã€‚`);
        });

        // 5. ç¶å®šæ¯é ç­†æ•¸è®Šå‹•äº‹ä»¶
        pageSizeSelect.addEventListener("change", (event) => {
            ROWS_PER_PAGE = parseInt(event.target.value, 10);

            // å¦‚æœç›®å‰æœ‰æŸ¥è©¢çµæœï¼Œå‰‡é‡æ–°æ¸²æŸ“è¡¨æ ¼å’Œåˆ†é ï¼Œä¸¦å›åˆ°ç¬¬ä¸€é 
            if (allResults.length > 0) {
                renderTablePage(1);
                messageArea.textContent = `æŸ¥è©¢æˆåŠŸï¼šå…± ${allResults.length} ç­†çµæœã€‚æ¯é é¡¯ç¤º ${ROWS_PER_PAGE} ç­†ã€‚`;
                messageArea.className = 'message-box success';
            } else {
                // åƒ…æ›´æ–°é¡¯ç¤ºè¨Šæ¯ (å¦‚æœæ²’æœ‰çµæœ)
                displayMessage(`å·²è¨­å®šæ¯é é¡¯ç¤º ${ROWS_PER_PAGE} ç­†ã€‚è«‹åŸ·è¡Œ SQL èªå¥ã€‚`);
            }
        });

        executeBtn.addEventListener("click", executeSql);

        sqlTextarea.addEventListener('keydown', (event) => {
            if (event.ctrlKey && event.key === 'Enter') {
                event.preventDefault();
                executeSql();
            }
        });
    });
</script>

</body>
</html>