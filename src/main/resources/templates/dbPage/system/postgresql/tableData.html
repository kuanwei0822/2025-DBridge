<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title id="page-title">è³‡æ–™è¡¨è³‡æ–™æª¢è¦–</title>

    <th:block th:if="${_csrf}">
        <meta name="_csrf" th:content="${_csrf.token}"/>
        <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    </th:block>

    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
            line-height: 1.6;
            background-color: #f4f7f6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #4b6cb7;
            border-bottom: 2px solid #4b6cb7;
            padding-bottom: 0.5em;
            margin-bottom: 1.5em;
        }

        /* æŸ¥è©¢æ§åˆ¶é … */
        .controls {
            margin-bottom: 1em;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        label {
            font-weight: bold;
            color: #333;
        }
        #page-size-select {
            padding: 8px 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            color: #333;
            cursor: pointer;
        }

        /* è¨Šæ¯å€å¡Š */
        .message-box {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-weight: bold;
            word-break: break-all;
        }
        .info {
            background-color: #e0f7fa;
            color: #00838f;
            border: 1px solid #00acc1;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* çµæœè¡¨æ ¼æ¨£å¼ */
        #results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
            table-layout: fixed;
        }
        #results-table th, #results-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 3em;
        }
        #results-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            cursor: pointer;
        }
        #results-table th.sorted-asc::after {
            content: " â–²";
        }
        #results-table th.sorted-desc::after {
            content: " â–¼";
        }
        #results-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* åˆ†é æ¨£å¼ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            gap: 5px;
        }
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            margin: 0 1px;
        }
        .pagination button:hover:not(:disabled) {
            background-color: #e0e0e0;
        }
        .pagination button.active {
            background-color: #4b6cb7;
            color: white;
            border-color: #4b6cb7;
        }
        .pagination-info {
            margin: 0 15px;
            font-weight: bold;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #007BFF;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        .back-link:hover {
            background-color: #0056b3;
        }

    </style>
</head>

<body>

<div class="container">
    <a href="#" id="back-to-metadata-link" class="back-link">â† è¿”å›è³‡æ–™è¡¨è©³æƒ…</a>

    <h1 id="table-title">è¼‰å…¥è³‡æ–™è¡¨è³‡æ–™...</h1>

    <div class="controls">
        <label for="page-size-select">æ¯é é¡¯ç¤º:</label>
        <select id="page-size-select">
            <option value="10">10 ç­†</option>
            <option value="25">25 ç­†</option>
            <option value="50" selected>50 ç­†</option>
            <option value="100">100 ç­†</option>
            <option value="200">200 ç­†</option>
        </select>

        <span id="loading-indicator" style="margin-left: 20px; color: #4b6cb7; display: none;">
            <i class="fa fa-spinner fa-spin"></i> è³‡æ–™è¼‰å…¥ä¸­...
        </span>
    </div>

    <div id="message-area" class="message-box info">
        æ­£åœ¨è¼‰å…¥è³‡æ–™...
    </div>

    <table id="results-table" style="display: none;">
        <thead>
        <tr id="results-header"></tr>
        </thead>
        <tbody id="results-body">
        </tbody>
    </table>

    <div id="pagination-controls">
    </div>

</div>

<script>
    const API_BASE_URL = "/DBridge/api/postgresql";
    const DATA_QUERY_URL = `${API_BASE_URL}/table/data`;

    // ğŸ’¡ æ­¥é©Ÿ 2: ç²å– CSRF Token å’Œ Header åç¨±
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

    // å–å¾— URL åƒæ•¸
    const urlParams = new URLSearchParams(window.location.search);
    const tableName = urlParams.get('tableName');
    const tableSchema = urlParams.get('schema');

    // å…ƒç´ åƒç…§
    const titleElement = document.getElementById("table-title");
    const messageArea = document.getElementById("message-area");
    const resultsTable = document.getElementById("results-table");
    const resultsHeader = document.getElementById("results-header");
    const resultsBody = document.getElementById("results-body");
    const pageSizeSelect = document.getElementById("page-size-select");
    const paginationControls = document.getElementById("pagination-controls");
    const loadingIndicator = document.getElementById("loading-indicator");
    const backLink = document.getElementById("back-to-metadata-link");

    // å…¨åŸŸåˆ†é ç‹€æ…‹
    let currentPage = 1;
    let totalCount = 0;
    let pageSize = parseInt(pageSizeSelect.value, 10);
    let currentOrderByColumn = null;
    let currentSortDirection = 'ASC'; // 'ASC' or 'DESC'

    // ğŸ’¡ æ­¥é©Ÿ 3: è¼”åŠ©å‡½æ•¸ - å–å¾—å¸¶æœ‰ CSRF Header çš„è«‹æ±‚è¨­å®š
    function getRequestOptions(bodyData) {
        const options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(bodyData)
        };

        // å¦‚æœ CSRF Token å­˜åœ¨ï¼Œå°±å°‡å…¶åŠ å…¥åˆ° Headers ä¸­
        if (csrfToken && csrfHeader) {
            options.headers[csrfHeader] = csrfToken;
        }
        return options;
    }


    // è¼”åŠ©å‡½æ•¸ï¼šHTML ç·¨ç¢¼
    function escapeHtml(s) {
        if (s === null || typeof s === 'undefined') return '';
        s = String(s);
        return s.replace(/[&<>"']/g, c => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
        }[c]));
    }

    // 1. åªæ›´æ–°è¨Šæ¯å€å¡Šçš„å…§å®¹å’Œæ¨£å¼
    function updateStatusMessage(message, type = 'info') {
        messageArea.textContent = message;
        messageArea.className = `message-box ${type}`;
    }

    // 2. è™•ç†éŒ¯èª¤å’Œè¼‰å…¥ç‹€æ…‹ï¼Œæ­¤æ™‚æ‰éœ€è¦éš±è—è¡¨æ ¼å’Œæ¸…é™¤å…§å®¹
    function handleErrorOrLoading(message, type = 'error') {
        updateStatusMessage(message, type);
        resultsTable.style.display = 'none';
        resultsBody.innerHTML = '';
        paginationControls.innerHTML = '';
    }

    // æ¸²æŸ“è¡¨æ ¼çš„æ¨™é ­ (ä¸€æ¬¡æ€§)
    function renderTableHeaders(columnNames) {
        // æ¸…é™¤èˆŠçš„æ’åºæ¨™è¨˜
        Array.from(resultsHeader.querySelectorAll('th')).forEach(th => {
            th.classList.remove('sorted-asc', 'sorted-desc');
        });

        const headersHtml = columnNames.map(col => {
            const escapedCol = escapeHtml(col);
            let sortClass = '';
            if (currentOrderByColumn === col) {
                sortClass = currentSortDirection === 'ASC' ? 'sorted-asc' : 'sorted-desc';
            }
            return `<th class="${sortClass}" data-column="${escapedCol}">${escapedCol}</th>`;
        }).join('');

        resultsHeader.innerHTML = headersHtml;

        // ç¶å®šæ¨™é ­é»æ“Šäº‹ä»¶ (æ’åº)
        resultsHeader.querySelectorAll('th').forEach(th => {
            th.addEventListener('click', () => {
                handleSort(th.dataset.column);
            });
        });
    }

    // æ¸²æŸ“è¡¨æ ¼çš„è³‡æ–™ (æ¯æ¬¡åˆ†é åˆ‡æ›)
    function renderTableBody(rows, columnNames) {
        const rowsHtml = rows.map(row => {
            const cellHtml = columnNames.map(col => {
                const cellValue = row[col] === null || typeof row[col] === 'undefined' || row[col] === "" ? 'â€”' : row[col];
                return `<td>${escapeHtml(cellValue)}</td>`;
            }).join('');
            return `<tr>${cellHtml}</tr>`;
        }).join('');

        resultsBody.innerHTML = rowsHtml;
        resultsTable.style.display = 'table';
    }

    // æ¸²æŸ“åˆ†é æ§åˆ¶æŒ‰éˆ•
    function renderPaginationControls() {
        const totalPages = Math.ceil(totalCount / pageSize);

        if (totalPages <= 1) {
            paginationControls.innerHTML = '';
            return;
        }

        let controlsHtml = '<div class="pagination">';

        // ç¸½è³‡è¨Š
        controlsHtml += `<span class="pagination-info">å…± ${totalCount} ç­†ï¼Œ${totalPages} é </span>`;

        // ä¸Šä¸€é æŒ‰éˆ• (æ–‡å­—å„ªåŒ–)
        controlsHtml += `<button id="prev-btn" ${currentPage === 1 ? 'disabled' : ''}>â† ä¸Šä¸€é </button>`;

        // --- é ç¢¼æŒ‰éˆ•é‚è¼¯ ---
        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        if (endPage - startPage + 1 < maxButtons) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        const pageNumbersToShow = new Set();
        pageNumbersToShow.add(1);
        for (let i = startPage; i <= endPage; i++) {
            pageNumbersToShow.add(i);
        }
        pageNumbersToShow.add(totalPages);

        const sortedPages = Array.from(pageNumbersToShow).sort((a, b) => a - b);
        let lastPage = 0;

        sortedPages.forEach(i => {
            if (i - lastPage > 1) {
                // é¡¯ç¤ºçœç•¥è™Ÿ
                controlsHtml += `<span style="margin: 0 5px;">...</span>`;
            }
            const activeClass = i === currentPage ? 'active' : '';
            // é»æ“Šå¾Œå‘¼å« fetchTableData é‡æ–°æŠ“å–è³‡æ–™
            controlsHtml += `<button class="${activeClass}" onclick="fetchTableData(${i})">${i}</button>`;
            lastPage = i;
        });
        // --- é ç¢¼æŒ‰éˆ•é‚è¼¯çµæŸ ---

        // ä¸‹ä¸€é æŒ‰éˆ• (æ–‡å­—å„ªåŒ–)
        controlsHtml += `<button id="next-btn" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é  â†’</button>`;

        controlsHtml += '</div>';

        paginationControls.innerHTML = controlsHtml;

        // ç¶å®šä¸Šä¸‹é æŒ‰éˆ•äº‹ä»¶
        document.getElementById('prev-btn').onclick = () => {
            if (currentPage > 1) fetchTableData(currentPage - 1);
        };
        document.getElementById('next-btn').onclick = () => {
            if (currentPage < totalPages) fetchTableData(currentPage + 1);
        };
    }

    // è™•ç†æ’åºé‚è¼¯
    function handleSort(columnName) {
        if (currentOrderByColumn === columnName) {
            currentSortDirection = currentSortDirection === 'ASC' ? 'DESC' : 'ASC';
        } else {
            currentOrderByColumn = columnName;
            currentSortDirection = 'ASC';
        }
        fetchTableData(1);
    }

    // ä¸»é‚è¼¯ï¼šç²å–è³‡æ–™
    async function fetchTableData(page = 1) {
        if (!tableName || !tableSchema) {
            handleErrorOrLoading("éŒ¯èª¤ï¼šURL ç¼ºå°‘ Schema æˆ– Table Name åƒæ•¸ã€‚", 'error');
            return;
        }

        currentPage = page;
        loadingIndicator.style.display = 'inline';
        updateStatusMessage(`æ­£åœ¨æŸ¥è©¢è³‡æ–™è¡¨ ${tableSchema}.${tableName} çš„ç¬¬ ${currentPage} é ...`, 'info');

        const requestBody = {
            schema: tableSchema,
            tableName: tableName,
            pageNumber: currentPage,
            pageSize: pageSize,
            orderByColumn: currentOrderByColumn,
            sortDirection: currentSortDirection
        };

        try {
            // ğŸ’¡ æ­¥é©Ÿ 4: ä½¿ç”¨ getRequestOptions æ›¿æ› fetch åƒæ•¸ï¼Œå¸¶ä¸Š CSRF Token
            const response = await fetch(DATA_QUERY_URL, getRequestOptions(requestBody));

            const apiResponse = await response.json();
            loadingIndicator.style.display = 'none';

            if (apiResponse.code !== "0") {
                const errorMessage = apiResponse.message || "æŸ¥è©¢è³‡æ–™å¤±æ•—";
                handleErrorOrLoading(`æŸ¥è©¢å¤±æ•—: ${errorMessage}`, 'error');
                return;
            }

            const result = apiResponse.data;

            if (!result || !Array.isArray(result.rows)) {
                handleErrorOrLoading("API å›å‚³çµæ§‹éŒ¯èª¤æˆ– rows æ¬„ä½ç¼ºå¤±ã€‚", 'error');
                return;
            }

            totalCount = result.totalCount || 0;
            const columnNames = result.columnNames || [];

            if (totalCount === 0 || columnNames.length === 0) {
                handleErrorOrLoading(`è³‡æ–™è¡¨ ${tableSchema}.${tableName} ç„¡ä»»ä½•è³‡æ–™ã€‚`, 'info');
                return;
            }

            // æ¸²æŸ“
            renderTableHeaders(columnNames);
            renderTableBody(result.rows, columnNames);
            renderPaginationControls();

            // æ›´æ–°æˆåŠŸè¨Šæ¯
            const totalPages = Math.ceil(totalCount / pageSize);
            updateStatusMessage(`æŸ¥è©¢æˆåŠŸï¼šå…± ${totalCount} ç­†è³‡æ–™ã€‚ç•¶å‰é é¢ï¼š${currentPage} / ${totalPages} (æ¯é  ${pageSize} ç­†)`, 'info');

        } catch (error) {
            loadingIndicator.style.display = 'none';
            console.error("Fetch API å¤±æ•—:", error);
            handleErrorOrLoading(`é€£ç·šæˆ–ç¶²è·¯éŒ¯èª¤: ${error.message || 'è«‹æª¢æŸ¥ API æœå‹™'}`, 'error');
        }
    }


    // æ ¸å¿ƒå•Ÿå‹•é‚è¼¯
    document.addEventListener("DOMContentLoaded", () => {
        // 1. æª¢æŸ¥ä¸¦è¨­å®šæ¨™é¡Œ
        if (!tableName || !tableSchema) {
            titleElement.textContent = "éŒ¯èª¤ï¼šç¼ºå°‘åƒæ•¸";
            handleErrorOrLoading("URL ç¼ºå°‘å¿…è¦çš„ schema æˆ– tableName åƒæ•¸ã€‚", 'error');
            return;
        }
        titleElement.textContent = `è³‡æ–™è¡¨è³‡æ–™æª¢è¦–ï¼š${tableSchema}.${tableName}`;
        document.getElementById("page-title").textContent = `è³‡æ–™è¡¨è³‡æ–™æª¢è¦–ï¼š${tableSchema}.${tableName}`;

        // 2. è¨­å®šã€Œè¿”å›è³‡æ–™è¡¨è©³æƒ…ã€é€£çµ
        backLink.href = `/DBridge/view/postgresql/tableMetadata?tableName=${encodeURIComponent(tableName)}&schema=${encodeURIComponent(tableSchema)}`;

        // 3. ç¶å®šæ¯é ç­†æ•¸è®Šå‹•äº‹ä»¶
        pageSizeSelect.addEventListener("change", (event) => {
            pageSize = parseInt(event.target.value, 10);
            fetchTableData(1);
        });

        // 4. é¦–æ¬¡è¼‰å…¥è³‡æ–™
        fetchTableData(1);
    });
</script>

</body>
</html>